<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>絶対に迷子にならないナビ</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    /* 地図全体 */
    #map {
      height: 100vh;
      width: 100vw;
      z-index: 0;
    }
    /* 目的地設定フォーム（常に表示） */
    #destinationForm {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1100;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }
    /* ルート案内パネル（最初は非表示） */
    #routeInfo {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1100;
      background: white;
      padding: 10px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      display: none;
    }
    /* 混雑情報パネル */
    #congestionInfo {
      position: fixed;
      top: 320px;
      right: 10px;
      z-index: 1100;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      font-size: 14px;
    }
    /* 情報リンクボタン（左下） */
    #infoButton {
      position: fixed;
      left: 10px;
      bottom: 10px;
      z-index: 1100;
      background: #28a745;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
    }
    /* コンパス表示ボタン（右下） */
    #compassButton {
      position: fixed;
      right: 10px;
      bottom: 10px;
      z-index: 1100;
      background: #FFA500;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
    }
    /* コンパス表示オーバーレイ */
    #compassDisplay {
      position: fixed;
      right: 10px;
      bottom: 60px;
      z-index: 1200;
      background: rgba(255,255,255,0.9);
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 5px;
      display: none;
      text-align: center;
      font-size: 14px;
    }
    /* ルート案内ステップのスタイル（背景白、画像付き） */
    .route-step {
      background: white;
      margin: 5px 0;
      padding: 5px;
      border-radius: 3px;
      font-size: 13px;
      display: flex;
      align-items: center;
    }
    .route-step img {
      width: 20px;
      height: 20px;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <!-- 地図表示 -->
  <div id="map"></div>
  
  <!-- 目的地設定フォーム -->
  <div id="destinationForm">
    <input type="text" id="destinationInput" placeholder="目的地を入力 (複数はカンマ区切り)">
    <button onclick="setDestination()">目的地設定</button>
  </div>
  
  <!-- ルート案内パネル -->
  <div id="routeInfo">
    <h3>ルート案内</h3>
    <div id="routeSteps"></div>
  </div>
  
  <!-- 混雑情報パネル -->
  <div id="congestionInfo">
    <strong>交通状況:</strong> <span id="congestionStatus">未取得</span>
  </div>
  
  <!-- 情報・お問い合わせリンクボタン -->
  <button id="infoButton" onclick="window.open('Information.html', '_blank')">
    使い方の詳細はこちら、お問い合わせも含む
  </button>
  
  <!-- コンパス表示ボタン -->
  <button id="compassButton" onclick="toggleCompass()">コンパス</button>
  <!-- コンパス表示オーバーレイ -->
  <div id="compassDisplay">方位: <span id="compassHeading">--°</span></div>
  
  <!-- Leaflet, Routing Machine, Geocoder のスクリプト -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.js"></script>
  
  <script>
    // 地図初期設定（東京）
    var map = L.map('map').setView([35.6895, 139.6917], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  
    var userMarker = null;
    var destinationMarker = null;
    var routeControl = null;
    var destinationCoordinates = null;
    var facilityMarkers = [];
  
    // 目的地ピン用赤いアイコン
    var redIcon = L.icon({
      iconUrl: 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|FF0000',
      iconSize: [21, 34],
      iconAnchor: [10, 34],
      popupAnchor: [0, -28]
    });
  
    // 現在地の更新（1秒ごと）
    function updateLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          var lat = pos.coords.latitude;
          var lon = pos.coords.longitude;
          if (!userMarker) {
            userMarker = L.marker([lat, lon]).addTo(map).bindPopup("現在地");
          } else {
            userMarker.setLatLng([lat, lon]);
          }
          map.setView([lat, lon], 13);
        }, function(err) {
          console.error("GPSエラー: " + err.message);
        });
      }
    }
    setInterval(updateLocation, 1000);
    updateLocation();
  
    // 目的地設定（複数地点対応：カンマ区切り）
    function setDestination() {
      var destInput = document.getElementById("destinationInput").value;
      if (!destInput) {
        alert("目的地を入力してください");
        return;
      }
      var addresses = destInput.split(",").map(function(a) { return a.trim(); });
      var geocoder = new L.Control.Geocoder.Nominatim();
      var geocodePromises = addresses.map(function(address) {
        return new Promise(function(resolve, reject) {
          geocoder.geocode(address, function(results) {
            if (results && results.length > 0) {
              resolve(results[0].center);
            } else {
              reject("住所が見つかりません: " + address);
            }
          });
        });
      });
      Promise.all(geocodePromises)
        .then(function(results) {
          var waypoints = results;
          destinationCoordinates = waypoints[waypoints.length - 1]; // 最後を目的地（優先度1）
          if (destinationMarker) map.removeLayer(destinationMarker);
          destinationMarker = L.marker(destinationCoordinates, { icon: redIcon })
                              .addTo(map).bindPopup("目的地");
          map.setView(destinationCoordinates, 13);
          startRoute(waypoints);
          fetchNearbyFacilities(destinationCoordinates.lat, destinationCoordinates.lng);
        })
        .catch(function(error) {
          alert(error);
        });
    }
  
    // ルート案内（生成されたルートレイヤーから指示データを取得して表示）
    function startRoute(waypoints) {
      if (!waypoints || !userMarker) return;
      if (routeControl) {
        map.removeControl(routeControl);
      }
      routeControl = L.Routing.control({
        waypoints: [L.latLng(userMarker.getLatLng())].concat(waypoints),
        routeWhileDragging: false,
        show: false,
        addWaypoints: false,
        createMarker: function() { return null; }
      }).addTo(map);
  
      // 生成されたルートレイヤーを背面に配置
      setTimeout(function(){
        try {
          routeControl.getRouter()._routeControl._routeLayer.setZIndex(-1);
        } catch(e){ console.error(e); }
      }, 1000);
  
      // 生成されたルートのデータを取得して、独自のルート案内パネルに表示
      routeControl.on('routesfound', function(e) {
        var route = e.routes[0];
        var instructions = [];
        route.legs.forEach(function(leg) {
          leg.steps.forEach(function(step) {
            instructions.push({
              instruction: step.maneuver.instruction,
              distance: step.distance
            });
          });
        });
        displayRouteInstructions(instructions);
      });
    }
  
    // 独自ルート案内の表示＆音声通知（画像付き）
    function displayRouteInstructions(data) {
      var stepsContainer = document.getElementById("routeSteps");
      stepsContainer.innerHTML = "";
      document.getElementById("routeInfo").style.display = "block";
  
      data.forEach(function(step, index) {
        var p = document.createElement("p");
        p.className = "route-step";
        var iconUrl = getInstructionIcon(step.instruction);
        var img = document.createElement("img");
        img.src = iconUrl;
        p.appendChild(img);
        var span = document.createElement("span");
        span.textContent = step.instruction + " (" + Math.round(step.distance) + "m)";
        p.appendChild(span);
        stepsContainer.appendChild(p);
  
        // 5秒間隔で音声通知
        setTimeout(function() {
          var utterance = new SpeechSynthesisUtterance(step.instruction);
          utterance.lang = 'ja-JP';
          window.speechSynthesis.speak(utterance);
        }, index * 5000);
      });
    }
  
    // 指示に応じた画像URLを返す関数
    function getInstructionIcon(instruction) {
      if (instruction.indexOf("右折") !== -1) {
        return "https://cdn-icons-png.flaticon.com/512/271/271228.png";
      } else if (instruction.indexOf("左折") !== -1) {
        return "https://cdn-icons-png.flaticon.com/512/271/271220.png";
      } else if (instruction.indexOf("直進") !== -1) {
        return "https://cdn-icons-png.flaticon.com/512/271/271210.png";
      } else {
        return "https://cdn-icons-png.flaticon.com/512/595/595553.png";
      }
    }
  
    // 周辺施設情報の取得（Overpass API、半径500m以内）
    function fetchNearbyFacilities(lat, lon) {
      facilityMarkers.forEach(function(marker) { map.removeLayer(marker); });
      facilityMarkers = [];
      var query = `
        [out:json];
        (
          node["amenity"="restaurant"](around:500,${lat},${lon});
          node["amenity"="cafe"](around:500,${lat},${lon});
          node["shop"="convenience"](around:500,${lat},${lon});
        );
        out;
      `;
      var url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
      fetch(url)
        .then(response => response.json())
        .then(data => {
          console.log("周辺施設データ:", data);
          if (data.elements && data.elements.length > 0) {
            data.elements.forEach(function(elem) {
              var marker = L.marker([elem.lat, elem.lon]).addTo(map);
              var name = elem.tags.name || (elem.tags.amenity || elem.tags.shop) || "施設";
              marker.bindPopup(name);
              facilityMarkers.push(marker);
            });
          } else {
            console.log("周辺施設情報が見つかりませんでした");
          }
        })
        .catch(error => console.error("周辺施設取得エラー:", error));
    }
  
    // 混雑情報の取得（Open511 API を使用、本番エンドポイント例）
    function fetchCongestionData() {
      var lat = userMarker ? userMarker.getLatLng().lat : 35.6895;
      var lon = userMarker ? userMarker.getLatLng().lng : 139.6917;
      var url = "https://open511.org/events?point=" + lat + "," + lon + "&radius=500";
      fetch(url)
        .then(response => response.json())
        .then(data => {
          // Open511 はイベント情報を返すので、イベントがあれば混雑と判断
          var status = (data.events && data.events.length > 0) ? "混雑" : "渋滞なし";
          document.getElementById("congestionStatus").textContent = status;
          if (status === "混雑") {
            var utterance = new SpeechSynthesisUtterance("現在、混雑しています。別ルートを検討してください。");
            utterance.lang = 'ja-JP';
            window.speechSynthesis.speak(utterance);
          }
        })
        .catch(error => {
          console.error("混雑情報取得エラー:", error);
          document.getElementById("congestionStatus").textContent = "取得エラー";
        });
    }
    setInterval(fetchCongestionData, 5000);
    fetchCongestionData();
  
    // コンパス表示機能
    var compassVisible = false;
    function toggleCompass() {
      var comp = document.getElementById("compassDisplay");
      compassVisible = !compassVisible;
      comp.style.display = compassVisible ? "block" : "none";
    }
    if (window.DeviceOrientationEvent) {
      window.addEventListener("deviceorientation", function(event) {
        var heading = event.alpha;
        if (heading !== null) {
          document.getElementById("compassHeading").textContent = Math.round(heading) + "°";
        }
      }, true);
    } else {
      document.getElementById("compassHeading").textContent = "未対応";
    }
  </script>
</body>
</html>
