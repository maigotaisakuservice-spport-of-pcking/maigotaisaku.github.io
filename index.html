<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>絶対に迷子にならないナビ</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    /* 地図全体 */
    #map {
      height: 100vh;
      width: 100vw;
      z-index: 0;
    }
    /* 目的地設定フォーム */
    #destinationForm {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1100;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }
    /* ルート案内パネル */
    #routeInfo {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1100;
      background: white;
      padding: 10px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      display: none;
    }
    /* 混雑情報パネル */
    #congestionInfo {
      position: fixed;
      top: 320px;
      right: 10px;
      z-index: 1100;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      font-size: 14px;
    }
    /* 情報・お問い合わせリンクボタン */
    #infoButton {
      position: fixed;
      left: 10px;
      bottom: 10px;
      z-index: 1100;
      background: #28a745;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
    }
    /* ルート案内ステップのスタイル */
    .route-step {
      background: white;
      margin: 5px 0;
      padding: 5px;
      border-radius: 3px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <!-- 地図表示 -->
  <div id="map"></div>
  
  <!-- 目的地設定フォーム -->
  <div id="destinationForm">
    <input type="text" id="destinationInput" placeholder="目的地を入力">
    <button onclick="setDestination()">目的地設定</button>
  </div>
  
  <!-- ルート案内パネル -->
  <div id="routeInfo">
    <h3>ルート案内</h3>
    <div id="routeSteps"></div>
  </div>
  
  <!-- 混雑情報パネル -->
  <div id="congestionInfo">
    <strong>交通状況:</strong>
    <span id="congestionStatus">未取得</span>
  </div>
  
  <!-- 情報・お問い合わせリンクボタン -->
  <button id="infoButton" onclick="window.open('Information.html', '_blank')">
    使い方の詳細はこちら、お問い合わせも含む
  </button>
  
  <!-- Leafletとライブラリのスクリプト -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.js"></script>
  
  <script>
    // 地図の初期設定（東京）
    var map = L.map('map').setView([35.6895, 139.6917], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  
    var userMarker = null;
    var destinationMarker = null;
    var routeControl = null;
    var destinationCoordinates = null;
    var facilityMarkers = [];
  
    // 目的地ピン用の赤いアイコン
    var redIcon = L.icon({
      iconUrl: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSBhff5PTAut_9P--DSb_sPfi5tevBj7ts9RA&s',
      iconSize: [21, 34],
      iconAnchor: [10, 34],
      popupAnchor: [0, -28]
    });
  
    // 現在地を1秒ごとに更新
    function updateLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
          var lat = pos.coords.latitude;
          var lon = pos.coords.longitude;
          if (!userMarker) {
            userMarker = L.marker([lat, lon]).addTo(map).bindPopup("現在地");
          } else {
            userMarker.setLatLng([lat, lon]);
          }
          map.setView([lat, lon], 13);
        }, function(err) {
          console.error("GPSエラー: " + err.message);
        });
      }
    }
    setInterval(updateLocation, 1000);
    updateLocation();
  
    // 目的地設定（Nominatimジオコーディング）
    function setDestination() {
      var dest = document.getElementById("destinationInput").value;
      if (!dest) {
        alert("目的地を入力してください");
        return;
      }
      var geocoder = new L.Control.Geocoder.Nominatim();
      geocoder.geocode(dest, function(results) {
        if (results.length > 0) {
          var latlng = results[0].center;
          destinationCoordinates = latlng;
          if (destinationMarker) map.removeLayer(destinationMarker);
          destinationMarker = L.marker(latlng, { icon: redIcon }).addTo(map).bindPopup("目的地");
          map.setView(latlng, 13);
          startRoute(latlng);
          fetchNearbyFacilities(latlng.lat, latlng.lon);
        } else {
          alert("目的地が見つかりません");
        }
      });
    }
  
    // ルート案内
    function startRoute(destination) {
      if (!destinationCoordinates || !userMarker) return;
      if (routeControl) {
        map.removeControl(routeControl);
      }
      routeControl = L.Routing.control({
        waypoints: [
          L.latLng(userMarker.getLatLng()),
          destination
        ],
        routeWhileDragging: false,
        show: false, // 既定のルート表示を非表示
        addWaypoints: false,
        createMarker: function() { return null; }
      }).addTo(map);
      // 生成されたルートレイヤーを背面に配置
      setTimeout(function(){
        try {
          routeControl.getRouter()._routeControl._routeLayer.setZIndex(-1);
        } catch(e){ console.error(e); }
      }, 1000);
  
      // カスタムルート案内データ（バリエーション拡充）
      const routeData = [
        { instruction: "50m先、右折してください", distance: 50 },
        { instruction: "150m先、左折してください", distance: 150 },
        { instruction: "300m直進してください", distance: 300 },
        { instruction: "交差点で右折してください", distance: 100 },
        { instruction: "目的地は右側にあります", distance: 20 },
        { instruction: "その先にコンビニがあります", distance: 100 },
        { instruction: "200m先にレストランがあります", distance: 200 },
        { instruction: "駅前を通る場合は注意してください", distance: 80 }
      ];
      displayRouteInstructions(routeData);
    }
  
    // カスタムルート案内表示＆音声通知
    function displayRouteInstructions(data) {
      var stepsContainer = document.getElementById("routeSteps");
      stepsContainer.innerHTML = "";
      document.getElementById("routeInfo").style.display = "block";
  
      data.forEach(function(step, index) {
        var p = document.createElement("p");
        p.className = "route-step";
        p.textContent = step.instruction + " (" + step.distance + "m)";
        stepsContainer.appendChild(p);
  
        // 5秒間隔で音声通知
        setTimeout(function() {
          var utterance = new SpeechSynthesisUtterance(step.instruction);
          utterance.lang = 'ja-JP';
          window.speechSynthesis.speak(utterance);
        }, index * 5000);
      });
    }
  
    // 周辺施設情報の取得（Overpass APIを利用、半径500m以内）
    function fetchNearbyFacilities(lat, lon) {
      facilityMarkers.forEach(function(marker) { map.removeLayer(marker); });
      facilityMarkers = [];
      var query = `
        [out:json];
        (
          node["amenity"="restaurant"](around:500,${lat},${lon});
          node["amenity"="cafe"](around:500,${lat},${lon});
          node["shop"="convenience"](around:500,${lat},${lon});
        );
        out;
      `;
      var url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
      fetch(url)
        .then(response => response.json())
        .then(data => {
          console.log("Overpass APIデータ:", data);
          if (data.elements && data.elements.length > 0) {
            data.elements.forEach(function(elem) {
              var marker = L.marker([elem.lat, elem.lon]).addTo(map);
              var name = elem.tags.name || (elem.tags.amenity || elem.tags.shop) || "施設";
              marker.bindPopup(name);
              facilityMarkers.push(marker);
            });
          } else {
            console.log("周辺施設情報が見つかりませんでした");
          }
        })
        .catch(error => console.error("周辺施設取得エラー:", error));
    }
  
    // 混雑情報の取得（無料APIシミュレーション：ランダム生成）
    function fetchCongestionData() {
      const statuses = ["渋滞なし", "普通", "混雑"];
      const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
      document.getElementById("congestionStatus").textContent = randomStatus;
      if (randomStatus === "混雑") {
        var utterance = new SpeechSynthesisUtterance("現在、混雑しています。別ルートを検討してください。");
        utterance.lang = 'ja-JP';
        window.speechSynthesis.speak(utterance);
      }
    }
    setInterval(fetchCongestionData, 5000);
    fetchCongestionData();
  
    // 最小化機能は削除済み（フォーム、パネルは常に表示）
  </script>
</body>
</html>
