<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>絶対に迷子にならないナビ</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    /* 地図全体 */
    #map {
      height: 100vh;
      width: 100vw;
      z-index: 0;
    }
    /* 目的地設定フォーム（左上固定） */
    #destinationForm {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1100;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      max-width: 300px;
    }
    /* 経由地入力欄コンテナ */
    #waypointsContainer {
      margin-top: 10px;
    }
    .waypointRow {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .waypointRow input[type="text"] {
      flex: 1;
      margin-right: 5px;
    }
    .waypointRow input[type="number"] {
      width: 50px;
      margin-right: 5px;
    }
    .waypointRow button {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 3px 6px;
      cursor: pointer;
    }
    #addWaypointButton {
      margin-top: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 5px 10px;
      cursor: pointer;
    }
    /* ルート案内パネル（右上固定、背景白） */
    #routeInfo {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1100;
      background: white;
      padding: 10px;
      border-radius: 5px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      display: none;
      width: 250px;
    }
    /* 混雑情報パネル */
    #congestionInfo {
      position: fixed;
      top: 320px;
      right: 10px;
      z-index: 1100;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      font-size: 14px;
    }
    /* 情報リンクボタン（左下） */
    #infoButton {
      position: fixed;
      left: 10px;
      bottom: 10px;
      z-index: 1100;
      background: #28a745;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
    }
    /* コンパス表示ボタン（右下） */
    #compassButton {
      position: fixed;
      right: 10px;
      bottom: 10px;
      z-index: 1100;
      background: #FFA500;
      color: white;
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
    }
    /* コンパス表示オーバーレイ（実際のコンパス風の円形、背景画像付き） */
    #compassDisplay {
      position: fixed;
      right: 10px;
      bottom: 60px;
      z-index: 1200;
      width: 80px;
      height: 80px;
      background: url('https://upload.wikimedia.org/wikipedia/commons/3/32/Compass_rose_simple.svg') no-repeat center center;
      background-size: cover;
      display: none;
    }
    /* ルート案内ステップのスタイル（背景白、画像付き） */
    .route-step {
      background: white;
      margin: 5px 0;
      padding: 5px;
      border-radius: 3px;
      font-size: 13px;
      display: flex;
      align-items: center;
    }
    .route-step img {
      width: 20px;
      height: 20px;
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <!-- 地図表示 -->
  <div id="map"></div>
  
  <!-- 目的地設定フォーム -->
  <div id="destinationForm">
    <input type="text" id="destinationInput" placeholder="目的地を入力 (優先度1)">
    <button onclick="setDestination()">目的地設定</button>
    <br>
    <button id="addWaypointButton" onclick="addWaypoint()">経由地追加</button>
    <div id="waypointsContainer"></div>
  </div>
  
  <!-- ルート案内パネル -->
  <div id="routeInfo">
    <h3>ルート案内</h3>
    <div id="routeSteps"></div>
  </div>
  
  <!-- 混雑情報パネル -->
  <div id="congestionInfo">
    <strong>交通状況:</strong> <span id="congestionStatus">未取得</span>
  </div>
  
  <!-- 情報リンクボタン -->
  <button id="infoButton" onclick="window.open('Information.html', '_blank')">
    使い方の詳細はこちら、お問い合わせも含む
  </button>
  
  <!-- コンパス表示ボタン -->
  <button id="compassButton" onclick="toggleCompass()">コンパス</button>
  <!-- コンパス表示オーバーレイ -->
  <div id="compassDisplay"></div>
  
  <!-- Leaflet, Routing Machine, Geocoder のスクリプト -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.js"></script>
  
  <script>
    // 地図初期設定（東京）
    var map = L.map('map').setView([35.6895, 139.6917], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  
    var userMarker = null;
    var destinationMarker = null;
    var routeControl = null;
    var destinationCoordinates = null;
    var facilityMarkers = [];
  
    // 目的地ピン用赤いアイコン（別画像）
    var redIcon = L.icon({
      iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/8/8d/Map_pin_icon_red.svg',
      iconSize: [24, 24],
      iconAnchor: [12, 12]
    });
  
    // 経由地動的追加（住所＋優先度＋削除ボタン）
    function addWaypoint() {
      var container = document.getElementById("waypointsContainer");
      var row = document.createElement("div");
      row.className = "waypointRow";
  
      var addrInput = document.createElement("input");
      addrInput.type = "text";
      addrInput.placeholder = "経由地を入力";
  
      var prioInput = document.createElement("input");
      prioInput.type = "number";
      prioInput.placeholder = "優先度";
      prioInput.value = 2; // 目的地は1
  
      var deleteBtn = document.createElement("button");
      deleteBtn.textContent = "×";
      deleteBtn.onclick = function() {
        container.removeChild(row);
      };
  
      row.appendChild(addrInput);
      row.appendChild(prioInput);
      row.appendChild(deleteBtn);
      container.appendChild(row);
    }
    document.getElementById("addWaypointButton").addEventListener("click", addWaypoint);
  
    // 目的地設定＋複数経由地対応
    function setDestination() {
      var destAddr = document.getElementById("destinationInput").value;
      if (!destAddr) {
        alert("目的地を入力してください");
        return;
      }
      var addresses = [];
      addresses.push({ address: destAddr, priority: 1 }); // 目的地は優先度1
      var container = document.getElementById("waypointsContainer");
      var rows = container.getElementsByClassName("waypointRow");
      for (var i = 0; i < rows.length; i++) {
        var inputs = rows[i].getElementsByTagName("input");
        var addr = inputs[0].value;
        var prio = Number(inputs[1].value) || 999;
        if (addr) {
          addresses.push({ address: addr, priority: prio });
        }
      }
      // 優先度順にソート（小さいほど先）
      addresses.sort(function(a, b) { return a.priority - b.priority; });
  
      var geocoder = new L.Control.Geocoder.Nominatim();
      var geocodePromises = addresses.map(function(item) {
        return new Promise(function(resolve, reject) {
          geocoder.geocode(item.address, function(results) {
            if (results && results.length > 0) {
              resolve({ center: results[0].center, priority: item.priority });
            } else {
              reject("住所が見つかりません: " + item.address);
            }
          });
        });
      });
      Promise.all(geocodePromises)
        .then(function(results) {
          results.sort(function(a, b) { return a.priority - b.priority; });
          var waypoints = results.map(function(item) { return item.center; });
          destinationCoordinates = waypoints[waypoints.length - 1]; // 最後が目的地
          if (destinationMarker) map.removeLayer(destinationMarker);
          destinationMarker = L.marker(destinationCoordinates, { icon: redIcon })
                              .addTo(map).bindPopup("目的地").bringToFront();
          map.setView(destinationCoordinates, 13);
          startRoute(waypoints);
          fetchNearbyFacilities(destinationCoordinates.lat, destinationCoordinates.lng);
        })
        .catch(function(error) {
          alert(error);
        });
    }
  
    // ルート案内（複数ウェイポイント対応、生成されたルートデータを独自に取得して表示）
    function startRoute(waypoints) {
      if (!waypoints || !userMarker) return;
      if (routeControl) {
        map.removeControl(routeControl);
      }
      routeControl = L.Routing.control({
        waypoints: [L.latLng(userMarker.getLatLng())].concat(waypoints),
        routeWhileDragging: false,
        show: false,
        addWaypoints: false,
        createMarker: function() { return null; }
      }).addTo(map);
      // 生成されたルートレイヤーを背面に配置
      setTimeout(function(){
        try {
          routeControl.getRouter()._routeControl._routeLayer.setZIndex(-1);
        } catch(e){ console.error(e); }
      }, 1000);
  
      // 生成されたルートのデータをそのまま取得して表示
      routeControl.on('routesfound', function(e) {
        var route = e.routes[0];
        var instructions = [];
        route.legs.forEach(function(leg) {
          leg.steps.forEach(function(step) {
            instructions.push({
              instruction: step.maneuver.instruction,
              distance: step.distance
            });
          });
        });
        displayRouteInstructions(instructions);
      });
    }
  
    // 独自ルート案内表示＆音声通知（画像付き）
    function displayRouteInstructions(data) {
      var stepsContainer = document.getElementById("routeSteps");
      stepsContainer.innerHTML = "";
      document.getElementById("routeInfo").style.display = "block";
  
      data.forEach(function(step, index) {
        var p = document.createElement("p");
        p.className = "route-step";
        var iconUrl = getInstructionIcon(step.instruction);
        var img = document.createElement("img");
        img.src = iconUrl;
        p.appendChild(img);
        var span = document.createElement("span");
        span.textContent = step.instruction + " (" + Math.round(step.distance) + "m)";
        p.appendChild(span);
        stepsContainer.appendChild(p);
  
        // 5秒間隔で音声通知
        setTimeout(function() {
          var utterance = new SpeechSynthesisUtterance(step.instruction);
          utterance.lang = 'ja-JP';
          window.speechSynthesis.speak(utterance);
        }, index * 5000);
      });
    }
  
    // 指示に応じた画像URLを返す関数
    function getInstructionIcon(instruction) {
      if (instruction.indexOf("右折") !== -1) {
        return "https://cdn-icons-png.flaticon.com/512/271/271228.png";
      } else if (instruction.indexOf("左折") !== -1) {
        return "https://cdn-icons-png.flaticon.com/512/271/271220.png";
      } else if (instruction.indexOf("直進") !== -1) {
        return "https://cdn-icons-png.flaticon.com/512/271/271210.png";
      } else {
        return "https://cdn-icons-png.flaticon.com/512/595/595553.png";
      }
    }
  
    // 周辺施設情報の取得（Overpass API、半径500m以内）
    function fetchNearbyFacilities(lat, lon) {
      facilityMarkers.forEach(function(marker) { map.removeLayer(marker); });
      facilityMarkers = [];
      var query = `
        [out:json];
        (
          node["amenity"="restaurant"](around:500,${lat},${lon});
          node["amenity"="cafe"](around:500,${lat},${lon});
          node["shop"="convenience"](around:500,${lat},${lon});
        );
        out;
      `;
      var url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
      fetch(url)
        .then(response => response.json())
        .then(data => {
          console.log("周辺施設データ:", data);
          if (data.elements && data.elements.length > 0) {
            data.elements.forEach(function(elem) {
              var marker = L.marker([elem.lat, elem.lon]).addTo(map);
              var name = elem.tags.name || (elem.tags.amenity || elem.tags.shop) || "施設";
              marker.bindPopup(name);
              facilityMarkers.push(marker);
            });
          } else {
            console.log("周辺施設情報が見つかりませんでした");
          }
        })
        .catch(error => console.error("周辺施設取得エラー:", error));
    }
  
    // 混雑情報の取得（Open511 API、本番エンドポイント：日本向け）
    function fetchCongestionData() {
      var lat = userMarker ? userMarker.getLatLng().lat : 35.6895;
      var lon = userMarker ? userMarker.getLatLng().lng : 139.6917;
      var url = "https://open511.jp/events?point=" + lat + "," + lon + "&radius=500";
      fetch(url)
        .then(response => response.json())
        .then(data => {
          var status = (data.events && data.events.length > 0) ? "混雑" : "渋滞なし";
          document.getElementById("congestionStatus").textContent = status;
          if (status === "混雑") {
            var utterance = new SpeechSynthesisUtterance("現在、混雑しています。別ルートを検討してください。");
            utterance.lang = 'ja-JP';
            window.speechSynthesis.speak(utterance);
          }
        })
        .catch(error => {
          console.error("混雑情報取得エラー:", error);
          document.getElementById("congestionStatus").textContent = "取得エラー";
        });
    }
    setInterval(fetchCongestionData, 5000);
    fetchCongestionData();
  
    // コンパス表示機能（実際のコンパス風）
    var compassVisible = false;
    function toggleCompass() {
      var comp = document.getElementById("compassDisplay");
      compassVisible = !compassVisible;
      comp.style.display = compassVisible ? "block" : "none";
    }
    if (window.DeviceOrientationEvent) {
      window.addEventListener("deviceorientation", function(event) {
        var heading = event.alpha;
        if (heading !== null) {
          // 数値表示はコンパスオーバーレイ内に含めてもよいが、今回は矢印回転のみ
          document.getElementById("compassDisplay").style.transform = "rotate(" + Math.round(heading) + "deg)";
        }
      }, true);
    } else {
      console.log("DeviceOrientationEvent 非対応");
    }
  </script>
</body>
</html>
