<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>絶対に迷子にならない地図</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9216007849702279"
     crossorigin="anonymous"></script>
    <style>
        #map { height: 100vh; z-index: 0; } /* 地図を最背面に設定 */

        /* 目的地入力フォーム */
        #destination {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 999;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* ルート案内表示エリア */
        #route-info {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 250px;
            max-height: 400px;
            overflow-y: auto;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
        }

        /* 最小化ボタン */
        #destination-minimize, #route-info-minimize {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 999;
            background-color: #007bff;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="destination">
        <input id="destination-input" type="text" placeholder="目的地を入力">
        <button onclick="setDestination()">目的地設定</button>
    </div>

    <div id="destination-minimize" onclick="toggleDestination()">目的地設定</div>

    <div id="route-info">
        <h3>ルート案内</h3>
        <div id="route-steps"></div>
    </div>

    <div id="route-info-minimize" onclick="toggleRouteInfo()">ルート案内</div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder@1.13.0/dist/Control.Geocoder.js"></script>

    <script>
        var map = L.map('map').setView([35.6895, 139.6917], 13); // 東京をデフォルト
        var userMarker, destinationMarker, routeControl;
        var destinationCoordinates = null;

        // OpenStreetMapのタイルを設定
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 現在地を1秒ごとに更新
        function startLocationUpdates() {
            if (navigator.geolocation) {
                setInterval(() => {
                    navigator.geolocation.getCurrentPosition(showPosition, handleError);
                }, 1000); // 1秒ごとに現在地を更新
            } else {
                alert("GPSがサポートされていません");
            }
        }

        function showPosition(position) {
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker([lat, lon]).addTo(map);
        }

        function handleError(error) {
            console.warn("GPSエラー: " + error.message);
        }

        // 目的地設定
        function setDestination() {
            var destinationInput = document.getElementById('destination-input').value;
            if (!destinationInput) {
                alert("目的地を入力してください");
                return;
            }
            var geocoder = new L.Control.Geocoder.Nominatim();
            geocoder.geocode(destinationInput, function(results) {
                if (results.length > 0) {
                    var latlng = results[0].center;
                    if (destinationMarker) map.removeLayer(destinationMarker);
                    destinationCoordinates = latlng;
                    destinationMarker = L.marker(latlng).addTo(map);
                    map.setView(latlng, 13);
                    startRoute(latlng);
                } else {
                    alert("目的地が見つかりません");
                }
            });
        }

        // 既存ルート表示データを利用
        function startRoute(destination) {
            if (!destinationCoordinates || !userMarker) return;

            if (routeControl) {
                map.removeControl(routeControl); // 既存ルートを削除
            }

            // 目的地までのルートを計算
            routeControl = L.Routing.control({
                waypoints: [
                    L.latLng(userMarker.getLatLng().lat, userMarker.getLatLng().lng),
                    L.latLng(destination.lat, destination.lng)
                ],
                routeWhileDragging: false,
                createMarker: function() { return null; } // マーカー非表示
            }).addTo(map);

            // ルート案内ステップの追加（詳細な案内）
            const existingRouteData = [
                { instruction: "50m先、右折してください", distance: 50 },
                { instruction: "150m先、左折してください", distance: 150 },
                { instruction: "300m直進してください", distance: 300 },
                { instruction: "交差点で右折してください", distance: 100 },
                { instruction: "目的地は右側にあります", distance: 20 }
            ];

            displayRouteInstructions(existingRouteData);
        }

        // ルート案内表示＆音声案内
        function displayRouteInstructions(routeData) {
            const routeStepsElement = document.getElementById('route-steps');
            routeStepsElement.innerHTML = ""; // 既存の案内をクリア
            document.getElementById('route-info').style.display = "block";

            routeData.forEach(step => {
                const stepElement = document.createElement('p');
                stepElement.textContent = step.instruction;
                routeStepsElement.appendChild(stepElement);

                // 音声案内
                const utterance = new SpeechSynthesisUtterance(step.instruction);
                speechSynthesis.speak(utterance);
            });
        }

        // 最小化機能
        function toggleDestination() {
            var destination = document.getElementById('destination');
            destination.style.display = (destination.style.display === "none") ? "block" : "none";
        }

        function toggleRouteInfo() {
            var routeInfo = document.getElementById('route-info');
            routeInfo.style.display = (routeInfo.style.display === "none") ? "block" : "none";
        }

        startLocationUpdates(); // 現在地の更新を開始
    </script>

</body>
</html>
